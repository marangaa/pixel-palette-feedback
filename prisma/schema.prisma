generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Conversation {
  id              String           @id @default(uuid())
  userId          String
  sessionId       String           @unique
  messages        Json // Array of { role: string, content: string }
  extractedData   ExtractedData?
  timestamp       DateTime         @default(now())
  analysisResults AnalysisResult[]

  @@index([userId])
  @@index([timestamp])
}

model ExtractedData {
  id              String       @id @default(uuid())
  conversationId  String       @unique
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  satisfaction    Float        @default(0)
  painPoints      String[]     @default([])
  featureRequests String[]     @default([])
  contact         Json? // { method: string, value: string }
  sentiment       String       @default("neutral")
  keyThemes       String[]     @default([])
  timestamp       DateTime     @default(now())

  @@index([sentiment])
}

model AnalysisResult {
  id              String       @id @default(uuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  shouldEnd       Boolean      @default(false)
  reason          String // user_request, complete_information, or continue
  missingElements String[]     @default([])
  nextQuestion    String?
  collectedInfo   Json // Structured info about what's been collected
  timestamp       DateTime     @default(now())

  @@index([conversationId])
}

model FeedbackAnalysis {
  id         String   @id @default(uuid())
  timeRange  Int // Analysis period in days
  categories Json // Contains feature_requests, bugs, improvements categories
  meta       Json // Analysis metadata with sentiment, trends, etc.
  insights   Json? // Optional additional insights
  stats      Json? // Optional additional statistics
  isLatest   Boolean  @default(false)
  timestamp  DateTime @default(now())

  @@index([timeRange])
  @@index([isLatest])
  @@index([timestamp])
}
